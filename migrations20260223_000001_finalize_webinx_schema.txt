BEGIN;

SET LOCAL lock_timeout = '5s';
SET LOCAL statement_timeout = '60s';

CREATE TABLE IF NOT EXISTS public.event_sources (
    id BIGSERIAL PRIMARY KEY,
    source_name VARCHAR(150) NOT NULL,
    base_url TEXT NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT uq_event_sources_source_name UNIQUE (source_name)
);

CREATE TABLE IF NOT EXISTS public.events (
    id BIGSERIAL PRIMARY KEY,
    title TEXT NOT NULL,
    event_date DATE NOT NULL,
    country VARCHAR(100) NOT NULL DEFAULT 'India',
    mode VARCHAR(20) NOT NULL DEFAULT 'online',
    event_url TEXT NOT NULL,
    source VARCHAR(150) NOT NULL,
    final_rank NUMERIC(7,2) NOT NULL DEFAULT 0,
    summary TEXT,
    location_text TEXT,
    starts_at TIMESTAMPTZ,
    ends_at TIMESTAMPTZ,
    metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

ALTER TABLE public.events
    ADD COLUMN IF NOT EXISTS title TEXT,
    ADD COLUMN IF NOT EXISTS event_date DATE,
    ADD COLUMN IF NOT EXISTS country VARCHAR(100) DEFAULT 'India',
    ADD COLUMN IF NOT EXISTS mode VARCHAR(20) DEFAULT 'online',
    ADD COLUMN IF NOT EXISTS event_url TEXT,
    ADD COLUMN IF NOT EXISTS source VARCHAR(150),
    ADD COLUMN IF NOT EXISTS final_rank NUMERIC(7,2) DEFAULT 0,
    ADD COLUMN IF NOT EXISTS summary TEXT,
    ADD COLUMN IF NOT EXISTS location_text TEXT,
    ADD COLUMN IF NOT EXISTS starts_at TIMESTAMPTZ,
    ADD COLUMN IF NOT EXISTS ends_at TIMESTAMPTZ,
    ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}'::jsonb,
    ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT TRUE,
    ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ DEFAULT NOW(),
    ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

ALTER TABLE public.events
    ALTER COLUMN country SET DEFAULT 'India',
    ALTER COLUMN mode SET DEFAULT 'online',
    ALTER COLUMN final_rank SET DEFAULT 0,
    ALTER COLUMN metadata SET DEFAULT '{}'::jsonb,
    ALTER COLUMN is_active SET DEFAULT TRUE,
    ALTER COLUMN created_at SET DEFAULT NOW(),
    ALTER COLUMN updated_at SET DEFAULT NOW();

DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM public.events WHERE country IS NULL) THEN
        UPDATE public.events SET country = 'India' WHERE country IS NULL;
    END IF;

    IF EXISTS (SELECT 1 FROM public.events WHERE mode IS NULL) THEN
        UPDATE public.events SET mode = 'online' WHERE mode IS NULL;
    END IF;

    IF EXISTS (SELECT 1 FROM public.events WHERE final_rank IS NULL) THEN
        UPDATE public.events SET final_rank = 0 WHERE final_rank IS NULL;
    END IF;

    IF EXISTS (SELECT 1 FROM public.events WHERE metadata IS NULL) THEN
        UPDATE public.events SET metadata = '{}'::jsonb WHERE metadata IS NULL;
    END IF;

    IF EXISTS (SELECT 1 FROM public.events WHERE is_active IS NULL) THEN
        UPDATE public.events SET is_active = TRUE WHERE is_active IS NULL;
    END IF;

    IF EXISTS (SELECT 1 FROM public.events WHERE created_at IS NULL) THEN
        UPDATE public.events SET created_at = NOW() WHERE created_at IS NULL;
    END IF;

    IF EXISTS (SELECT 1 FROM public.events WHERE updated_at IS NULL) THEN
        UPDATE public.events SET updated_at = NOW() WHERE updated_at IS NULL;
    END IF;
END $$;

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint
        WHERE conname = 'chk_events_title_not_blank'
          AND conrelid = 'public.events'::regclass
    ) THEN
        ALTER TABLE public.events
            ADD CONSTRAINT chk_events_title_not_blank
            CHECK (LENGTH(BTRIM(title)) >= 3)
            NOT VALID;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint
        WHERE conname = 'chk_events_valid_mode'
          AND conrelid = 'public.events'::regclass
    ) THEN
        ALTER TABLE public.events
            ADD CONSTRAINT chk_events_valid_mode
            CHECK (mode IN ('online', 'offline', 'hybrid'))
            NOT VALID;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint
        WHERE conname = 'chk_events_non_negative_rank'
          AND conrelid = 'public.events'::regclass
    ) THEN
        ALTER TABLE public.events
            ADD CONSTRAINT chk_events_non_negative_rank
            CHECK (final_rank >= 0)
            NOT VALID;
    END IF;

    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint
        WHERE conname = 'uq_events_source_url_date'
          AND conrelid = 'public.events'::regclass
    ) THEN
        ALTER TABLE public.events
            ADD CONSTRAINT uq_events_source_url_date
            UNIQUE (source, event_url, event_date);
    END IF;

    IF NOT EXISTS (
        SELECT 1
        FROM pg_constraint
        WHERE conname = 'fk_events_source_name'
          AND conrelid = 'public.events'::regclass
    ) THEN
        ALTER TABLE public.events
            ADD CONSTRAINT fk_events_source_name
            FOREIGN KEY (source)
            REFERENCES public.event_sources(source_name)
            ON UPDATE CASCADE
            ON DELETE RESTRICT;
    END IF;
END $$;

CREATE INDEX IF NOT EXISTS idx_events_event_date ON public.events (event_date);
CREATE INDEX IF NOT EXISTS idx_events_country_event_date ON public.events (country, event_date DESC);
CREATE INDEX IF NOT EXISTS idx_events_rank_event_date ON public.events (final_rank DESC, event_date DESC);
CREATE INDEX IF NOT EXISTS idx_events_active_event_date ON public.events (is_active, event_date DESC);
CREATE INDEX IF NOT EXISTS idx_events_mode ON public.events (mode);
CREATE INDEX IF NOT EXISTS idx_events_metadata_gin ON public.events USING GIN (metadata);

CREATE OR REPLACE FUNCTION public.set_updated_at_timestamp()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1
        FROM pg_trigger
        WHERE tgname = 'trg_event_sources_set_updated_at'
          AND tgrelid = 'public.event_sources'::regclass
    ) THEN
        CREATE TRIGGER trg_event_sources_set_updated_at
            BEFORE UPDATE ON public.event_sources
            FOR EACH ROW
            EXECUTE FUNCTION public.set_updated_at_timestamp();
    END IF;

    IF NOT EXISTS (
        SELECT 1
        FROM pg_trigger
        WHERE tgname = 'trg_events_set_updated_at'
          AND tgrelid = 'public.events'::regclass
    ) THEN
        CREATE TRIGGER trg_events_set_updated_at
            BEFORE UPDATE ON public.events
            FOR EACH ROW
            EXECUTE FUNCTION public.set_updated_at_timestamp();
    END IF;
END $$;

COMMIT;
