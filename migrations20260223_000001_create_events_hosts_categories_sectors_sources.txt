CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE IF NOT EXISTS hosts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    slug TEXT NOT NULL,
    website_url TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT hosts_name_nonempty_chk CHECK (BTRIM(name) <> ''),
    CONSTRAINT hosts_slug_nonempty_chk CHECK (BTRIM(slug) <> ''),
    CONSTRAINT hosts_website_url_chk CHECK (website_url IS NULL OR website_url ~* '^https?://')
);

CREATE TABLE IF NOT EXISTS categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    slug TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT categories_name_nonempty_chk CHECK (BTRIM(name) <> ''),
    CONSTRAINT categories_slug_nonempty_chk CHECK (BTRIM(slug) <> '')
);

CREATE TABLE IF NOT EXISTS sectors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    slug TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT sectors_name_nonempty_chk CHECK (BTRIM(name) <> ''),
    CONSTRAINT sectors_slug_nonempty_chk CHECK (BTRIM(slug) <> '')
);

CREATE TABLE IF NOT EXISTS sources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    slug TEXT NOT NULL,
    source_type TEXT NOT NULL,
    base_url TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT sources_name_nonempty_chk CHECK (BTRIM(name) <> ''),
    CONSTRAINT sources_slug_nonempty_chk CHECK (BTRIM(slug) <> ''),
    CONSTRAINT sources_source_type_chk CHECK (source_type IN ('api', 'rss', 'scraper', 'manual', 'partner')),
    CONSTRAINT sources_base_url_chk CHECK (base_url IS NULL OR base_url ~* '^https?://')
);

CREATE TABLE IF NOT EXISTS events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_id UUID NOT NULL,
    host_id UUID,
    category_id UUID,
    sector_id UUID,
    external_event_id TEXT NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    event_url TEXT,
    registration_url TEXT,
    location_name TEXT,
    country_code CHAR(2),
    event_mode TEXT NOT NULL DEFAULT 'hybrid',
    status TEXT NOT NULL DEFAULT 'draft',
    starts_at TIMESTAMPTZ NOT NULL,
    ends_at TIMESTAMPTZ,
    timezone TEXT,
    is_free BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT events_source_fk FOREIGN KEY (source_id) REFERENCES sources(id),
    CONSTRAINT events_host_fk FOREIGN KEY (host_id) REFERENCES hosts(id),
    CONSTRAINT events_category_fk FOREIGN KEY (category_id) REFERENCES categories(id),
    CONSTRAINT events_sector_fk FOREIGN KEY (sector_id) REFERENCES sectors(id),
    CONSTRAINT events_external_event_id_nonempty_chk CHECK (BTRIM(external_event_id) <> ''),
    CONSTRAINT events_title_nonempty_chk CHECK (BTRIM(title) <> ''),
    CONSTRAINT events_event_url_chk CHECK (event_url IS NULL OR event_url ~* '^https?://'),
    CONSTRAINT events_registration_url_chk CHECK (registration_url IS NULL OR registration_url ~* '^https?://'),
    CONSTRAINT events_country_code_chk CHECK (country_code IS NULL OR country_code ~ '^[A-Z]{2}$'),
    CONSTRAINT events_event_mode_chk CHECK (event_mode IN ('online', 'offline', 'hybrid')),
    CONSTRAINT events_status_chk CHECK (status IN ('draft', 'published', 'cancelled', 'archived')),
    CONSTRAINT events_ends_at_gte_starts_at_chk CHECK (ends_at IS NULL OR ends_at >= starts_at),
    CONSTRAINT events_timezone_nonempty_chk CHECK (timezone IS NULL OR BTRIM(timezone) <> ''),
    CONSTRAINT events_source_external_unique UNIQUE (source_id, external_event_id)
);

CREATE UNIQUE INDEX IF NOT EXISTS hosts_slug_uq_idx ON hosts (slug);
CREATE UNIQUE INDEX IF NOT EXISTS categories_slug_uq_idx ON categories (slug);
CREATE UNIQUE INDEX IF NOT EXISTS sectors_slug_uq_idx ON sectors (slug);
CREATE UNIQUE INDEX IF NOT EXISTS sources_slug_uq_idx ON sources (slug);

CREATE INDEX IF NOT EXISTS events_source_id_idx ON events (source_id);
CREATE INDEX IF NOT EXISTS events_host_id_idx ON events (host_id);
CREATE INDEX IF NOT EXISTS events_category_id_idx ON events (category_id);
CREATE INDEX IF NOT EXISTS events_sector_id_idx ON events (sector_id);
CREATE INDEX IF NOT EXISTS events_starts_at_idx ON events (starts_at);
CREATE INDEX IF NOT EXISTS events_status_idx ON events (status);
CREATE INDEX IF NOT EXISTS events_event_mode_idx ON events (event_mode);
CREATE INDEX IF NOT EXISTS events_country_code_idx ON events (country_code);
